<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Responsable - CalmaTEA</title>
  <link rel="stylesheet" href="css/estilo.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="panel-container">
    <h1 id="saludo"></h1>

    <h2>Tutelados asociados</h2>
    <ul id="listaTutelados"></ul>

    <h2>Estad铆sticas del tutelado seleccionado</h2>

    <div class="graphics-row">
    <div class="card grafica">
      <h3>Emociones registradas</h3>
      <canvas id="emocionesChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>T茅cnicas utilizadas</h3>
        <canvas id="tecnicasChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>Historias reproducidas</h3>
        <canvas id="historiasChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>Causas de emoci贸n</h3>
        <canvas id="causasChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>Respuestas historias</h3>
        <canvas id="respuestasChart"></canvas>
      </div>
    </div>
    
    <button id="logoutBtn" class="login-btn">Cerrar sesi贸n</button>
    <button id="asociarBtn" class="login-btn">Asociar tutelado</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
const API_URL = "https://skill-backend-ijg4.onrender.com";
const nombre = localStorage.getItem('nombre');
const token = localStorage.getItem('token');

if (!token || !nombre) {
  window.location.href = 'login.html';
}

document.getElementById('saludo').textContent = ` Hola, ${nombre}`;

async function obtenerTutelados() {
  try {
    const res = await fetch(`${API_URL}/tutorias/tutelados`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Error al obtener tutelados");
    const tutelados = await res.json();

    const lista = document.getElementById('listaTutelados');
    lista.innerHTML = '';

    if (tutelados.length === 0) {
      lista.innerHTML = '<p>No tienes tutelados asociados.</p>';
      return;
    }

    tutelados.forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${t.nombre} (ID: ${t.idUsuario})`;
      li.style.cursor = 'pointer';
      li.addEventListener('click', () => cargarEstadisticasTutelado(t.idUsuario, t.nombre, li));
      lista.appendChild(li);
    });
  } catch (err) {
    console.error(err);
  }
}

async function cargarEstadisticasTutelado(idTutelado, nombreTutelado, elemento) {
  document.querySelectorAll('#listaTutelados li').forEach(li => li.classList.remove('activo'));
  elemento.classList.add('activo');

  if (window.graficas) window.graficas.forEach(g => g.destroy());
  window.graficas = [];

  const [emocionesRes, tecnicasRes, historiasRes] = await Promise.all([
    fetch(`${API_URL}/emociones/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
    fetch(`${API_URL}/tecnicas/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
    fetch(`${API_URL}/historias/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } })
  ]);

  const emociones = await emocionesRes.json();
  const tecnicas = await tecnicasRes.json();
  const historias = await historiasRes.json();

  renderGraficas(emociones, tecnicas, historias, nombreTutelado);
}

function agruparPorDiaYCategoria(datos, categoriaKey) {
  const agrupado = {};
  datos.forEach(d => {
    if (!d.timestamp) return;
    const fecha = new Date(d.timestamp).toISOString().split('T')[0];
    if (!agrupado[fecha]) agrupado[fecha] = {};
    const cat = d[categoriaKey];
    agrupado[fecha][cat] = (agrupado[fecha][cat] || 0) + 1;
  });
  return agrupado;
}

function agruparPorDosCampos(datos, campo1, campo2) {
  const conteo = {};
  datos.forEach(d => {
    if (!d[campo1] || !d[campo2]) return;
    const clave = `${d[campo1]} - ${d[campo2]}`;
    conteo[clave] = (conteo[clave] || 0) + 1;
  });
  return conteo;
}

function renderGraficas(emociones, tecnicas, historias, nombre) {
  if (window.graficas) window.graficas.forEach(g => g.destroy());
  window.graficas = [];

  const coloresEmociones = { alegre: '#FF9999', triste: '#FFD966', enfadado: '#9AD0F5' };
  const coloresHistorias = {
    'Me han gritado': '#C39BD3', 'Me han empujado': '#AF7AC5',
    'Se han re铆do de m铆': '#D2B4DE', 'Me han ignorado': '#EBDEF0', 'Me han quitado algo': '#E8DAEF'
  };
  const coloresTecnicas = {
    'Respiraci贸n guiada': '#82E0AA', 'Sonido de olas': '#5DADE2',
    'Sonido de lluvia': '#AED6F1', 'Visualizaci贸n relajante': '#A3E4D7'
  };

  //  EMOCIONES POR DA
  const emocionesAgr = agruparPorDiaYCategoria(emociones, 'emocion');
  const fechasE = Object.keys(emocionesAgr).sort();
  const tiposEmo = [...new Set(emociones.map(e => e.emocion))];
  const emocionesDatasets = tiposEmo.map(e => ({
    label: e, data: fechasE.map(f => emocionesAgr[f][e] || 0),
    backgroundColor: coloresEmociones[e] || '#CCC'
  }));

  const emocionesChart = new Chart(document.getElementById('emocionesChart'), {
    type: 'bar',
    data: { labels: fechasE, datasets: emocionesDatasets },
    options: {
      plugins: {
        title: { display: true, text: `Emociones diarias de ${nombre}` },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} veces` } }
      },
      scales: {
        x: { title: { display: true, text: 'Fecha' } },
        y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' }, ticks: { stepSize: 1, precision: 0 } }
      }
    }
  });

  //  TCNICAS POR DA
  const tecnicasAgr = agruparPorDiaYCategoria(tecnicas, 'tecnica');
  const fechasT = Object.keys(tecnicasAgr).sort();
  const tiposTec = [...new Set(tecnicas.map(t => t.tecnica))];
  const tecnicasDatasets = tiposTec.map(t => ({
    label: t, data: fechasT.map(f => tecnicasAgr[f][t] || 0),
    backgroundColor: coloresTecnicas[t] || '#B3E5FC'
  }));

  const tecnicasChart = new Chart(document.getElementById('tecnicasChart'), {
    type: 'bar',
    data: { labels: fechasT, datasets: tecnicasDatasets },
    options: {
      plugins: {
        title: { display: true, text: `T茅cnicas realizadas por ${nombre}` },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} veces` } }
      },
      scales: {
        x: { title: { display: true, text: 'Fecha' } },
        y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' }, ticks: { stepSize: 1, precision: 0 } }
      }
    }
  });

  //  HISTORIAS POR DA
  const historiasAgr = agruparPorDiaYCategoria(historias, 'historiaId');
  const fechasH = Object.keys(historiasAgr).sort();
  const tiposHis = [...new Set(historias.map(h => h.historiaId))];
  const historiasDatasets = tiposHis.map(h => ({
    label: h, data: fechasH.map(f => historiasAgr[f][h] || 0),
    backgroundColor: coloresHistorias[h] || '#CCC'
  }));

  const historiasChart = new Chart(document.getElementById('historiasChart'), {
    type: 'bar',
    data: { labels: fechasH, datasets: historiasDatasets },
    options: {
      plugins: {
        title: { display: true, text: `Historias vistas por ${nombre}` },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} veces` } }
      },
      scales: {
        x: { title: { display: true, text: 'Fecha' } },
        y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' }, ticks: { stepSize: 1, precision: 0 } }
      }
    }
  });

  //  CAUSAS
  const causasValidas = emociones.filter(e => e.causa && e.causa.trim() !== '');
  if (causasValidas.length > 0) {
    const causasCount = agruparPorDosCampos(causasValidas, 'emocion', 'causa');
    const causasLabels = Object.keys(causasCount);
    const causasChart = new Chart(document.getElementById('causasChart'), {
      type: 'bar',
      data: { labels: causasLabels, datasets: [{ label: 'Causas', data: Object.values(causasCount), backgroundColor: '#F8C471' }] },
      options: {
        plugins: {
          title: { display: true, text: `Causas asociadas a emociones de ${nombre}` },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed.y} veces` } }
        },
        indexAxis: 'y',
        scales: { x: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } }
      }
    });
    window.graficas.push(causasChart);
  }

  //  RESPUESTAS
  const respuestasValidas = historias.filter(h => h.respuesta && h.respuesta.trim() !== '');
  if (respuestasValidas.length > 0) {
    const respuestasCount = agruparPorDosCampos(respuestasValidas, 'historiaId', 'respuesta');
    const respuestasLabels = Object.keys(respuestasCount);
    const respuestasChart = new Chart(document.getElementById('respuestasChart'), {
      type: 'bar',
      data: { labels: respuestasLabels, datasets: [{ label: 'Respuestas', data: Object.values(respuestasCount), backgroundColor: '#AED6F1' }] },
      options: {
        plugins: {
          title: { display: true, text: `Respuestas dadas en historias por ${nombre}` },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed.y} veces` } }
        },
        indexAxis: 'y',
        scales: { x: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } }
      }
    });
    window.graficas.push(respuestasChart);
  }

  window.graficas.push(emocionesChart, tecnicasChart, historiasChart);
}

// Botones
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.clear();
  window.location.href = 'index.html';
});
document.getElementById('asociarBtn').addEventListener('click', () => {
  window.location.href = 'asociar.html';
});

obtenerTutelados();
</script>


</body>
</html>
