<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Responsable - CalmaTEA</title>
  <link rel="stylesheet" href="css/estilo.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="panel-container">
    <h1 id="saludo"></h1>

    <h2>Tutelados asociados</h2>
    <ul id="listaTutelados"></ul>

    <h2>Estad√≠sticas del tutelado seleccionado</h2>

    <div class="graphics-row">
    <div class="card grafica">
      <h3>Emociones registradas</h3>
      <canvas id="emocionesChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>T√©cnicas utilizadas</h3>
        <canvas id="tecnicasChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>Historias reproducidas</h3>
        <canvas id="historiasChart"></canvas>
      </div>
    </div>
    
    <button id="logoutBtn" class="login-btn">Cerrar sesi√≥n</button>
    <button id="asociarBtn" class="login-btn">Asociar tutelado</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
  const API_URL = "https://skill-backend-ijg4.onrender.com";
  const nombre = localStorage.getItem('nombre');
  const token = localStorage.getItem('token');

  if (!token || !nombre) {
    window.location.href = 'login.html';
  }

  document.getElementById('saludo').textContent = ` Hola, ${nombre}`;

  async function obtenerTutelados() {
    try {
      const res = await fetch(`${API_URL}/tutorias/tutelados`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Error al obtener tutelados");
      const tutelados = await res.json();

      const lista = document.getElementById('listaTutelados');
      lista.innerHTML = '';

      if (tutelados.length === 0) {
        lista.innerHTML = '<p>No tienes tutelados asociados.</p>';
        return;
      }

      tutelados.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.nombre} (ID: ${t.idUsuario})`;
        li.style.cursor = 'pointer';
        li.addEventListener('click', () => cargarEstadisticasTutelado(t.idUsuario, t.nombre, li));
        lista.appendChild(li);
      });
    } catch (err) {
      console.error(err);
    }
  }

  async function cargarEstadisticasTutelado(idTutelado, nombreTutelado, elemento) {
    document.querySelectorAll('#listaTutelados li').forEach(li => li.classList.remove('activo'));
    elemento.classList.add('activo');

    if (window.graficas) window.graficas.forEach(g => g.destroy());
    window.graficas = [];

    const [emocionesRes, tecnicasRes, historiasRes] = await Promise.all([
      fetch(`${API_URL}/emociones/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
      fetch(`${API_URL}/tecnicas/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
      fetch(`${API_URL}/historias/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } })
    ]);

    const emociones = await emocionesRes.json();
    const tecnicas = await tecnicasRes.json();
    const historias = await historiasRes.json();

    renderGraficas(emociones, tecnicas, historias, nombreTutelado);
  }

  function renderGraficas(emociones, tecnicas, historias, nombre) {
    if (window.graficas) window.graficas.forEach(g => g.destroy());
    window.graficas = [];

    // üé® Paletas de colores coherentes
    const coloresEmociones = { alegre: '#FF9999', triste: '#FFD966', enfadado: '#9AD0F5' };
    const coloresTecnicas = {
      'Respiraci√≥n guiada': '#82E0AA',
      'Sonido de olas': '#5DADE2',
      'Sonido de lluvia': '#AED6F1',
      'Visualizaci√≥n relajante': '#A3E4D7'
    };
    const coloresHistorias = {
      'Me han gritado': '#C39BD3',
      'Me han empujado': '#AF7AC5',
      'Se han re√≠do de m√≠': '#D2B4DE',
      'Me han ignorado': '#EBDEF0',
      'Me han quitado algo': '#E8DAEF'
    };

    // --- üß† EMOCIONES (gr√°fico temporal)
    const emocionesTemporal = emociones.map(e => ({
      x: new Date(e.timestamp),
      y: 1,
      emocion: e.emocion,
      causa: e.causa
    }));

    const emocionesChart = new Chart(document.getElementById('emocionesChart'), {
      type: 'line',
      data: {
        datasets: [{
          label: 'Emociones registradas',
          data: emocionesTemporal,
          borderColor: '#FF9999',
          tension: 0.3,
          pointBackgroundColor: emocionesTemporal.map(e => coloresEmociones[e.emocion] || '#CCC')
        }]
      },
      options: {
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' },
            title: { display: true, text: 'Fecha' }
          },
          y: { beginAtZero: true, ticks: { stepSize: 1 }, display: false }
        },
        plugins: {
          title: { display: true, text: `Evoluci√≥n de emociones de ${nombre}` },
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => {
                const e = ctx.raw;
                return `${e.emocion}${e.causa ? ` - ${e.causa}` : ''}`;
              }
            }
          }
        }
      }
    });

    // --- üß© T√âCNICAS (barras)
    const tecnicasCount = {};
    tecnicas.forEach(t => tecnicasCount[t.tecnica] = (tecnicasCount[t.tecnica] || 0) + 1);
    const tecnicasLabels = Object.keys(tecnicasCount);
    const tecnicasChart = new Chart(document.getElementById('tecnicasChart'), {
      type: 'bar',
      data: {
        labels: tecnicasLabels,
        datasets: [{
          label: 'T√©cnicas',
          data: Object.values(tecnicasCount),
          backgroundColor: tecnicasLabels.map(t => coloresTecnicas[t] || '#B3E5FC')
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } }
        },
        plugins: {
          title: { display: true, text: `T√©cnicas realizadas por ${nombre}` },
          legend: { display: false }
        }
      }
    });

    // --- üìö HISTORIAS (gr√°fico temporal)
    const historiasTemporal = historias.map(h => ({
      x: new Date(h.timestamp),
      y: 1,
      historiaId: h.historiaId,
      respuesta: h.respuesta
    }));

    const historiasChart = new Chart(document.getElementById('historiasChart'), {
      type: 'line',
      data: {
        datasets: [{
          label: 'Historias reproducidas',
          data: historiasTemporal,
          borderColor: '#C39BD3',
          tension: 0.3,
          pointBackgroundColor: historiasTemporal.map(h => coloresHistorias[h.historiaId] || '#CCC')
        }]
      },
      options: {
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' },
            title: { display: true, text: 'Fecha' }
          },
          y: { beginAtZero: true, ticks: { stepSize: 1 }, display: false }
        },
        plugins: {
          title: { display: true, text: `Historias vistas por ${nombre}` },
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => {
                const h = ctx.raw;
                return `${h.historiaId} - Respuesta: ${h.respuesta}`;
              }
            }
          }
        }
      }
    });

    window.graficas = [emocionesChart, tecnicasChart, historiasChart];
  }

  // Botones
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });

  document.getElementById('asociarBtn').addEventListener('click', () => {
    window.location.href = 'asociar.html';
  });

  obtenerTutelados();
</script>

</body>
</html>
