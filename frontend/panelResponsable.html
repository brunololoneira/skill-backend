<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Responsable - CalmaTEA</title>
  <link rel="stylesheet" href="css/estilo.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="panel-container">
    <h1 id="saludo"></h1>

    <h2>Tutelados asociados</h2>
    <ul id="listaTutelados"></ul>

    <h2>Estad√≠sticas del tutelado seleccionado</h2>

    <div class="graphics-row">
    <div class="card grafica">
      <h3>Emociones registradas</h3>
      <canvas id="emocionesChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>T√©cnicas utilizadas</h3>
        <canvas id="tecnicasChart"></canvas>
      </div>

      <div class="card grafica">
        <h3>Historias reproducidas</h3>
        <canvas id="historiasChart"></canvas>
      </div>
    </div>
    
    <button id="logoutBtn" class="login-btn">Cerrar sesi√≥n</button>
    <button id="asociarBtn" class="login-btn">Asociar tutelado</button>
  </div>

  <script>
    const API_URL = "https://skill-backend-ijg4.onrender.com";
    const nombre = localStorage.getItem('nombre');
    const token = localStorage.getItem('token');

    // Verificaci√≥n b√°sica
    if (!token || !nombre) {
      window.location.href = 'login.html';
    }

    document.getElementById('saludo').textContent = `üëã Hola, ${nombre}`;

    // ---- OBTENER TUTELADOS ----
    async function obtenerTutelados() {
      try {
        const res = await fetch(`${API_URL}/tutorias/tutelados`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Error al obtener tutelados");
        const tutelados = await res.json();

        const lista = document.getElementById('listaTutelados');
        lista.innerHTML = '';

        if (tutelados.length === 0) {
          lista.innerHTML = '<p>No tienes tutelados asociados.</p>';
          return;
        }

        tutelados.forEach(t => {
          const li = document.createElement('li');
          li.textContent = `${t.nombre} (ID: ${t.idUsuario})`;
          li.style.cursor = 'pointer';
          li.addEventListener('click', () => cargarEstadisticasTutelado(t.idUsuario, t.nombre, li));
          lista.appendChild(li);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ---- CARGAR ESTAD√çSTICAS DE UN TUTELADO ----
    async function cargarEstadisticasTutelado(idTutelado, nombreTutelado, elemento) {
      // Resalta al seleccionado
      document.querySelectorAll('#listaTutelados li').forEach(li => li.classList.remove('activo'));
      elemento.classList.add('activo');

      // Destruye las gr√°ficas anteriores
      if (window.graficas) {
        window.graficas.forEach(g => g.destroy());
      }
      window.graficas = [];

      // Carga datos y dibuja
      const [emocionesRes, tecnicasRes, historiasRes] = await Promise.all([
        fetch(`${API_URL}/emociones/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
        fetch(`${API_URL}/tecnicas/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
        fetch(`${API_URL}/historias/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } })
      ]);

      const emociones = await emocionesRes.json();
      const tecnicas = await tecnicasRes.json();
      const historias = await historiasRes.json();

      renderGraficas(emociones, tecnicas, historias, nombreTutelado);
    }

    // ---- RENDERIZAR GR√ÅFICAS ----
    function renderGraficas(emociones, tecnicas, historias, nombre) {
      // Contar emociones
      const emocionesCount = {};
      emociones.forEach(e => {
        emocionesCount[e.emocion] = (emocionesCount[e.emocion] || 0) + 1;
      });

      // Contar t√©cnicas
      const tecnicasCount = {};
      tecnicas.forEach(t => {
        tecnicasCount[t.tecnica] = (tecnicasCount[t.tecnica] || 0) + 1;
      });

      // Contar historias
      const historiasCount = {};
      historias.forEach(h => {
        historiasCount[h.historiaId] = (historiasCount[h.historiaId] || 0) + 1;
      });

      // Paletas fijas coherentes con CalmaTEA
      const coloresEmociones = {
        alegre: '#FF9999',
        triste: '#FFD966',
        enfadado: '#9AD0F5'
      };

      const coloresTecnicas = {
        'Respiraci√≥n guiada': '#82E0AA',
        'Sonido de olas': '#5DADE2',
        'Sonido de lluvia': '#AED6F1',
        'Visualizaci√≥n relajante': '#A3E4D7'
      };

      const coloresHistorias = {
        'Me han gritado': '#C39BD3',
        'Me han empujado': '#AF7AC5',
        'Se han re√≠do de m√≠': '#D2B4DE',
        'Me han ignorado': '#EBDEF0',
        'Me han quitado algo': '#E8DAEF'
      };

      // Destruye gr√°ficas previas si existen
      if (window.graficas) window.graficas.forEach(g => g.destroy());
      window.graficas = [];

      // --- Emociones (gr√°fico tipo pastel)
      const emocionesChart = new Chart(document.getElementById('emocionesChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(emocionesCount),
          datasets: [{
            data: Object.values(emocionesCount),
            backgroundColor: Object.keys(emocionesCount).map(e => coloresEmociones[e] || '#CCC')
          }]
        },
        options: {
          plugins: {
            title: { display: true, text: `Emociones de ${nombre}` },
            legend: { display: true, position: 'bottom' },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}` } }
          }
        }
      });

      // --- T√©cnicas (barras con colores fijos y leyenda)
      const tecnicasLabels = Object.keys(tecnicasCount);
      const tecnicasChart = new Chart(document.getElementById('tecnicasChart'), {
        type: 'bar',
        data: {
          labels: tecnicasLabels,
          datasets: [{
            label: 'T√©cnicas',
            data: Object.values(tecnicasCount),
            backgroundColor: tecnicasLabels.map(t => coloresTecnicas[t] || '#B3E5FC')
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1, precision: 0 }
            }
          },
          plugins: {
            title: { display: true, text: `T√©cnicas realizadas por ${nombre}` },
            legend: { display: true, position: 'bottom' },
            tooltip: {
              callbacks: {
                title: ctx => ctx[0].label,
                label: ctx => `${ctx.parsed.y} veces`
              }
            }
          }
        }
      });

      // --- Historias (barras con colores fijos y leyenda)
      const historiasLabels = Object.keys(historiasCount);
      const historiasChart = new Chart(document.getElementById('historiasChart'), {
        type: 'bar',
        data: {
          labels: historiasLabels,
          datasets: [{
            label: 'Historias',
            data: Object.values(historiasCount),
            backgroundColor: historiasLabels.map(h => coloresHistorias[h] || '#D7BDE2')
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1, precision: 0 }
            }
          },
          plugins: {
            title: { display: true, text: `Historias vistas por ${nombre}` },
            legend: { display: true, position: 'bottom' },
            tooltip: {
              callbacks: {
                title: ctx => ctx[0].label,
                label: ctx => `${ctx.parsed.y} veces`
              }
            }
          }
        }
      });

      // Guardar para limpiar luego
      window.graficas = [emocionesChart, tecnicasChart, historiasChart];
    }



    // ---- CERRAR SESI√ìN ----
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'index.html';
    });

    // ---- IR A ASOCIAR ----
    document.getElementById('asociarBtn').addEventListener('click', () => {
      window.location.href = 'asociar.html';
    });
    obtenerTutelados();
  </script>
</body>
</html>
