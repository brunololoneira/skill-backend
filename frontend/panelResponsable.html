<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Responsable - CalmaTEA</title>
  <link rel="stylesheet" href="css/estilo.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="panel-container">
    <h1 id="saludo"></h1>

    <h2>Tutelados asociados</h2>
    <ul id="listaTutelados"></ul>

    <h2>Estad√≠sticas del tutelado seleccionado</h2>

<div class="graphics-container">
  <!-- FILA 1 -->
  <div class="graphics-row">
    <div class="card grafica">
      <h3>Emociones registradas</h3>
      <canvas id="emocionesChart"></canvas>
    </div>

    <div class="card grafica">
      <h3>T√©cnicas utilizadas</h3>
      <canvas id="tecnicasChart"></canvas>
    </div>

    <div class="card grafica">
      <h3>Historias reproducidas</h3>
      <canvas id="historiasChart"></canvas>
    </div>
  </div>

  <!-- FILA 2 -->
  <div class="graphics-row center-row">
    <div class="card grafica">
      <h3>Causas de emoci√≥n</h3>
      <canvas id="causasChart"></canvas>
    </div>

    <div class="card grafica">
      <h3>Respuestas historias</h3>
      <canvas id="respuestasChart"></canvas>
    </div>
  </div>
</div>


    <button id="logoutBtn" class="login-btn">Cerrar sesi√≥n</button>
    <button id="asociarBtn" class="login-btn">Asociar tutelado</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
const API_URL = "https://skill-backend-ijg4.onrender.com";
const nombre = localStorage.getItem('nombre');
const token = localStorage.getItem('token');

if (!token || !nombre) {
  window.location.href = 'login.html';
}

document.getElementById('saludo').textContent = `üëã Hola, ${nombre}`;

// =============== UTILIDADES ===============
function agruparPorDiaYCategoria(datos, key) {
  const agrupado = {};
  datos.forEach(d => {
    if (!d.timestamp) return;
    const fecha = new Date(d.timestamp).toISOString().split('T')[0];
    if (!agrupado[fecha]) agrupado[fecha] = {};
    const cat = d[key];
    agrupado[fecha][cat] = (agrupado[fecha][cat] || 0) + 1;
  });
  return agrupado;
}

function agruparPorDiaYDosCampos(datos, c1, c2) {
  const agrupado = {};
  datos.forEach(d => {
    if (!d.timestamp || !d[c1] || !d[c2]) return;
    const fecha = new Date(d.timestamp).toISOString().split('T')[0];
    if (!agrupado[fecha]) agrupado[fecha] = {};
    const clave = `${d[c1]} - ${d[c2]}`;
    agrupado[fecha][clave] = (agrupado[fecha][clave] || 0) + 1;
  });
  return agrupado;
}

// =============== DATOS Y GR√ÅFICAS ===============
async function obtenerTutelados() {
  const res = await fetch(`${API_URL}/tutorias/tutelados`, { headers: { 'Authorization': `Bearer ${token}` } });
  const tutelados = await res.json();
  const lista = document.getElementById('listaTutelados');
  lista.innerHTML = '';

  tutelados.forEach(t => {
    const li = document.createElement('li');
    li.textContent = `${t.nombre} (ID: ${t.idUsuario})`;
    li.style.cursor = 'pointer';
    li.addEventListener('click', () => cargarEstadisticasTutelado(t.idUsuario, t.nombre, li));
    lista.appendChild(li);
  });
}

async function cargarEstadisticasTutelado(idTutelado, nombreTutelado, elemento) {
  document.querySelectorAll('#listaTutelados li').forEach(li => li.classList.remove('activo'));
  elemento.classList.add('activo');

  if (window.graficas) window.graficas.forEach(g => g.destroy());
  window.graficas = [];

  const [emocionesRes, tecnicasRes, historiasRes] = await Promise.all([
    fetch(`${API_URL}/emociones/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
    fetch(`${API_URL}/tecnicas/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } }),
    fetch(`${API_URL}/historias/${idTutelado}`, { headers: { 'Authorization': `Bearer ${token}` } })
  ]);

  const emociones = await emocionesRes.json();
  const tecnicas = await tecnicasRes.json();
  const historias = await historiasRes.json();

  renderGraficas(emociones, tecnicas, historias, nombreTutelado);
}

function renderGraficas(emociones, tecnicas, historias, nombre) {
  if (window.graficas) window.graficas.forEach(g => g.destroy());
  window.graficas = [];

  // Paletas b√°sicas
  const coloresBase = [
    '#FF9999', '#FFD966', '#9AD0F5', '#C39BD3', '#82E0AA', '#AED6F1',
    '#A3E4D7', '#F8C471', '#B2BABB', '#E8DAEF', '#F5B7B1', '#BB8FCE'
  ];
  let colorIndex = 0;
  const getColor = () => coloresBase[(colorIndex++) % coloresBase.length];

  // --- EMOCIONES ---
  const emoAgr = agruparPorDiaYCategoria(emociones, 'emocion');
  const fechasE = Object.keys(emoAgr).sort();
  const tiposE = [...new Set(emociones.map(e => e.emocion))];
  const emoDatasets = tiposE.map(e => ({
    label: e,
    data: fechasE.map(f => emoAgr[f][e] || 0),
    backgroundColor: getColor()
  }));
  const emocionesChart = new Chart(document.getElementById('emocionesChart'), {
    type: 'bar',
    data: { labels: fechasE, datasets: emoDatasets },
    options: {
      plugins: {
        title: { display: true, text: `Emociones diarias de ${nombre}` },
        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y} veces` } }
      },
      scales: { x: { title: { display: true, text: 'Fecha' } },
                y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } } }
    }
  });

  // --- T√âCNICAS ---
  const tecAgr = agruparPorDiaYCategoria(tecnicas, 'tecnica');
  const fechasT = Object.keys(tecAgr).sort();
  const tiposT = [...new Set(tecnicas.map(t => t.tecnica))];
  const tecDatasets = tiposT.map(t => ({
    label: t, data: fechasT.map(f => tecAgr[f][t] || 0), backgroundColor: getColor()
  }));
  const tecnicasChart = new Chart(document.getElementById('tecnicasChart'), {
    type: 'bar',
    data: { labels: fechasT, datasets: tecDatasets },
    options: {
      plugins: {
        title: { display: true, text: `T√©cnicas realizadas por ${nombre}` },
        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y} veces` } }
      },
      scales: { x: { title: { display: true, text: 'Fecha' } },
                y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } } }
    }
  });

  // --- HISTORIAS ---
  const hisAgr = agruparPorDiaYCategoria(historias, 'historiaId');
  const fechasH = Object.keys(hisAgr).sort();
  const tiposH = [...new Set(historias.map(h => h.historiaId))];
  const hisDatasets = tiposH.map(h => ({
    label: h, data: fechasH.map(f => hisAgr[f][h] || 0), backgroundColor: getColor()
  }));
  const historiasChart = new Chart(document.getElementById('historiasChart'), {
    type: 'bar',
    data: { labels: fechasH, datasets: hisDatasets },
    options: {
      plugins: {
        title: { display: true, text: `Historias vistas por ${nombre}` },
        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y} veces` } }
      },
      scales: { x: { title: { display: true, text: 'Fecha' } },
                y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } } }
    }
  });

  // --- CAUSAS ---
  const causasValidas = emociones.filter(e => e.causa && e.causa.trim());
  if (causasValidas.length > 0) {
    const causasAgr = agruparPorDiaYDosCampos(causasValidas, 'emocion', 'causa');
    const fechasC = Object.keys(causasAgr).sort();
    const tiposC = [...new Set(causasValidas.map(e => `${e.emocion} - ${e.causa}`))];
    const causasDatasets = tiposC.map(c => ({
      label: c, data: fechasC.map(f => causasAgr[f][c] || 0), backgroundColor: getColor()
    }));
    const causasChart = new Chart(document.getElementById('causasChart'), {
      type: 'bar',
      data: { labels: fechasC, datasets: causasDatasets },
      options: {
        plugins: {
          title: { display: true, text: `Causas asociadas a emociones de ${nombre}` },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} veces` } }
        },
        scales: { x: { title: { display: true, text: 'Fecha' } },
                  y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } } }
      }
    });
    window.graficas.push(causasChart);
  }

  // --- RESPUESTAS ---
  const respuestasValidas = historias.filter(h => h.respuesta && h.respuesta.trim());
  if (respuestasValidas.length > 0) {
    const respAgr = agruparPorDiaYDosCampos(respuestasValidas, 'historiaId', 'respuesta');
    const fechasR = Object.keys(respAgr).sort();
    const tiposR = [...new Set(respuestasValidas.map(h => `${h.historiaId} - ${h.respuesta}`))];
    const respDatasets = tiposR.map(r => ({
      label: r, data: fechasR.map(f => respAgr[f][r] || 0), backgroundColor: getColor()
    }));
    const respuestasChart = new Chart(document.getElementById('respuestasChart'), {
      type: 'bar',
      data: { labels: fechasR, datasets: respDatasets },
      options: {
        plugins: {
          title: { display: true, text: `Respuestas dadas en historias por ${nombre}` },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} veces` } }
        },
        scales: { x: { title: { display: true, text: 'Fecha' } },
                  y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } } }
      }
    });
    window.graficas.push(respuestasChart);
  }

  window.graficas.push(emocionesChart, tecnicasChart, historiasChart);
}

// === BOTONES ===
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.clear();
  window.location.href = 'index.html';
});
document.getElementById('asociarBtn').addEventListener('click', () => {
  window.location.href = 'asociar.html';
});

obtenerTutelados();
</script>



</body>
</html>
